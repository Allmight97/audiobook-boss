### Hand-off: Refactor prep, tests, and safety baselining (2025-08-07)

#### What changed (high-level)
- Test hygiene:
  - Extracted inline tests to `src-tauri/tests/unit/**` for: `errors`, `audio/session`, `audio/metrics`, `metadata/{reader,writer}`, `ffmpeg/mod`, and `commands` (split into basic/audio/metadata).
  - Converted `unwrap/unwrap_err` usages in tests to `expect/expect_err` and fixed clippy format suggestions.
  - Moved `tests/audio/processor_tests.rs` → `tests/unit/audio/processor_tests.rs` and updated imports.
- Tooling:
  - Added `scripts/sg/size_budget.sh` to report modules >400 lines and heuristic functions >60 lines.
- Planning docs:
  - `docs/planning/mvp-roadmap.md` (scope, criteria, milestones).
  - `docs/planning/refactor-plan.md` (test extraction, module split plan, FFmpeg boundary).

#### Why these changes
- Establish clear test structure to support future refactors without regressions.
- Reduce clippy failures and improve test clarity (better failure messages via `expect`).
- Provide size visibility and a roadmap for progressively shrinking “godzilla” modules.

#### Current status (post-change snapshot)
- cargo test: green.
- cargo clippy: clean of unwrap errors; warnings limited to `dead_code` on scaffolding (context/builders/guards).
- Size report (files >400 lines):
  - `src-tauri/src/audio/processor.rs` (631)
  - `src/ui/fileList.ts` (521)
  - `src-tauri/src/audio/progress.rs` (485)
  - `src-tauri/src/audio/cleanup.rs` (480)
  - `src/ui/statusPanel.ts` (443)
  - `src-tauri/tests/unit/audio/processor_tests.rs` (412) [test-only; OK]
  - `src-tauri/src/tests_integration.rs` (410)

#### Lingering code smells and risks
- Oversized modules: the five listed above; increase cognitive load and change risk.
- Inline tests still present in: `audio/{file_list.rs, progress.rs, settings.rs}`, `ffmpeg/command.rs` (depend on private APIs). Keep for now; move after defining testable boundaries.
- Dead code warnings: scaffolding types and builder methods not fully wired yet.
- FFmpeg shell command path building: concat list still interpolates paths (mitigated by `-safe 0` and stdin list). Centralized escaping helper still pending.

#### Recommendations (actionable next steps)
1) Finish test extraction (safe subset)
   - Promote minimal visibility for specific test targets via `pub(crate)` or small test adapters, then move tests for:
     - `audio/settings.rs` (validation functions)
     - `audio/progress.rs` (parser/report helpers)
     - `ffmpeg/command.rs` (parse_version; builder checks)
     - `audio/file_list.rs` (format validator)
   - Keep changes minimal; do not broaden API unnecessarily.

2) Introduce FFmpeg boundary (no behavior change)
   - Define trait `MediaProcessor` and implement `ShellFFmpegProcessor` wrapping existing command flow.
   - Wire `processor` to call through the trait. This unlocks later `ffmpeg-next` migration.

3) Module trimming (small, serial edits)
   - Deferred until after Safety/robustness and FFmpeg boundary (per current plan).
   - When resumed: `audio/progress.rs` → split into `progress/{reporter.rs, parser.rs}`; `audio/processor.rs` → `processor/{prepare.rs, execute.rs, finalize.rs}`; `commands/mod.rs` split by domain; UI TS files split into state/DOM/actions.

4) Safety/robustness quick wins
   - Add a shared `escape_ffmpeg_path(&str) -> String` and use in concat generation sites (`ffmpeg/command.rs::create_concat_list`, `audio/processor.rs::create_concat_file`).
   - Canonicalize paths and strip CR/LF/NUL via the shared helper (DONE). Full input path validation (exists/is_file/extension whitelist; canonicalize) will be implemented alongside the ffmpeg-next boundary.

5) Process reliability (backlog)
   - Progressive shutdown for ffmpeg child (TERM→KILL) in progress monitor.
   - RAII guards finalized across session/cleanup when boundary is introduced.

#### Junior-dev note: inline vs external tests in Rust
- Inline tests are common because they can access private items. External tests (in `tests/`) compile as a separate crate and see only public items.
- It’s fine to keep some inline tests while designing a public boundary. When you’re ready, make tiny `pub(crate)` adapters or elevate specific functions to move tests out.
- Production crates often keep some inline tests (unit-level) and add external tests for integration/black-box checks. You don’t have to remove inline tests for production.

#### Session wrap-up and next steps
- We halted further code changes at this point to avoid exceeding session context.
- Next session, proceed in this order:
  1. Implement `escape_ffmpeg_path` and path validation; apply in both concat sites.
  2. Introduce `MediaProcessor` trait and `ShellFFmpegProcessor`; route current processing via the trait (no behavior change).
  3. Add feature-gated `FfmpegNextProcessor` (stub/initial) without switching defaults.
  4. Re-run tests and clippy, update docs.
  5. Defer module trimming until after the above are merged and stable.

#### Consolidated plan (canonical)

- Pre-ffmpeg-next
  - [X] Shared `escape_ffmpeg_path` implemented and used in all concat sites — DONE
  - [ ] Introduce `MediaProcessor` trait and `ShellFFmpegProcessor`; route current processing via the trait (no behavior change)
  - [ ] Ensure child reaping after cancel: after `kill()` polling, call best-effort `wait()`
  - [ ] Prefer bundled FFmpeg for releases; optionally verify checksum of bundled binary

- Post-ffmpeg-next
  - [ ] Feature flag scaffold (`safe-ffmpeg`) and a non-default `FfmpegNextProcessor` implementation
  - [ ] Gradually migrate off concat files; retire `escape_ffmpeg_path` once not needed
  - [ ] Maintain input path validation (exists, is regular file, extension whitelist); canonicalize; define symlink/base-dir/base-path policy as needed
  - [ ] Optional: write-permission probe for output directory
  - [ ] Tests green and clippy clean (minus known dead_code scaffolding); docs refreshed to reflect changes


